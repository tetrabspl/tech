<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tetra Tech | My App Store</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-light">

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
  <img src="images/logo.png" alt="Tetra Tech Logo" height="36">
  <span class="fw-bold">Tetra Tech</span>
</a>


    <div class="ms-auto d-flex gap-2 align-items-center">
      <a id="adminBtn" href="admin.html" class="btn btn-warning btn-sm d-none">
        ðŸ‘‘ Admin
      </a>

      <a id="loginBtn" href="login.html" class="btn btn-outline-light btn-sm">
        Login
      </a>

      <a id="registerBtn" href="register.html" class="btn btn-outline-info btn-sm">
        Register
      </a>

      <button id="logoutBtn" class="btn btn-danger btn-sm d-none" onclick="logout()">
        Logout
      </button>
    </div>
  </div>
</nav>

<!-- ================= CONTENT ================= -->
<div class="container mt-5">
  <h2 class="mb-4 fw-bold">Available Apps</h2>
  <div id="apps" class="row g-4"></div>
</div>

<!-- ================= FIREBASE SDKs ================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Firebase Config -->
<script src="js/firebase.js"></script>

<!-- ================= AUTH + ROLE LOGIC ================= -->
<script>
firebase.auth().onAuthStateChanged(async function (user) {

  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const adminBtn = document.getElementById("adminBtn");

  if (!user) {
    loginBtn.classList.remove("d-none");
    registerBtn.classList.remove("d-none");
    logoutBtn.classList.add("d-none");
    adminBtn.classList.add("d-none");
    loadApps();
    return;
  }

  loginBtn.classList.add("d-none");
  registerBtn.classList.add("d-none");
  logoutBtn.classList.remove("d-none");

  const doc = await firebase.firestore()
    .collection("users")
    .doc(user.uid)
    .get();

  if (doc.exists && doc.data().role === "admin") {
    adminBtn.classList.remove("d-none");
  } else {
    adminBtn.classList.add("d-none");
  }

  loadApps();
});

function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "index.html";
  });
}
</script>

<!-- ================= LOAD APPS ================= -->
<script>
function loadApps() {
  const db = firebase.firestore();
  const container = document.getElementById("apps");

  container.innerHTML = "<p>Loading apps...</p>";

  db.collection("apps")
    .where("active", "==", true)
    .get()
    .then(snapshot => {
      let html = "";

      if (snapshot.empty) {
        container.innerHTML = "<p>No apps available</p>";
        return;
      }

      snapshot.forEach(doc => {
        const app = doc.data();

        html += `
          <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 rounded-4">
              <div class="card-body d-flex flex-column">
                <h5 class="fw-bold">${app.name}</h5>
                <p class="text-muted">${app.desc}</p>
                <div class="mt-auto">
                  <button class="btn btn-primary w-100"
                    onclick="startCheckout('${doc.id}')">
                    Buy â‚¹${app.price}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    })
    .catch(err => {
      console.error(err);
      container.innerHTML = "<p>Error loading apps</p>";
    });
}

function startCheckout(appId) {
  if (!firebase.auth().currentUser) {
    window.location.href = "login.html";
  } else {
    window.location.href = "checkout.html?id=" + appId;
  }
}
</script>

</body>
</html>
