<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow">
    <div class="card-body">
      <h3 id="appName">Loading...</h3>
      <p id="appDesc"></p>
      <h4 id="appPrice"></h4>

      <button class="btn btn-success mt-3" onclick="payNow()">
        Pay with Razorpay
      </button>
    </div>
  </div>
</div>

<!-- Firebase base -->
<script src="js/firebase.js"></script>

<script>
  // ðŸ”¹ Read app id from URL
  const params = new URLSearchParams(window.location.search);
  const appId = params.get("id");

  let selectedApp = null;
  let orderId = null;

  // ðŸ”¹ Load app details from Firestore
  setTimeout(() => {
    if (!appId) {
      alert("Invalid app!");
      window.location.href = "index.html";
      return;
    }

    const db = firebase.firestore();

    db.collection("apps").doc(appId).get()
      .then(doc => {
        if (!doc.exists) {
          alert("App not found!");
          window.location.href = "index.html";
          return;
        }

        selectedApp = doc.data();

        document.getElementById("appName").innerText = selectedApp.name;
        document.getElementById("appDesc").innerText = selectedApp.desc;
        document.getElementById("appPrice").innerText = "â‚¹" + selectedApp.price;
      });
  }, 1500);

  // ðŸ”¹ Pay button logic
  function payNow() {
    const user = firebase.auth().currentUser;
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    if (!selectedApp) {
      alert("App not loaded yet. Please wait.");
      return;
    }

    const db = firebase.firestore();

    // 1ï¸âƒ£ Create order (PENDING)
    db.collection("orders").add({
      userId: user.uid,
      email: user.email,
      appName: selectedApp.name,
      price: selectedApp.price,
      status: "PENDING",
      createdAt: new Date()
    }).then(docRef => {
      orderId = docRef.id;
      openRazorpay();
    });
  }

  // ðŸ”¹ Open Razorpay popup
  function openRazorpay() {
    var options = {
      key: "rzp_test_Rqcvqire4Uc5pP",   // TEST KEY
      amount: selectedApp.price * 100,
      currency: "INR",
      name: "My App Store",
      description: selectedApp.name,
      handler: function (response) {
        paymentSuccess(response);
      },
      theme: {
        color: "#3399cc"
      }
    };

    var rzp = new Razorpay(options);
    rzp.open();
  }

  // ðŸ”¹ Payment success handler
  function paymentSuccess(response) {
    const db = firebase.firestore();

    db.collection("orders").doc(orderId).update({
      status: "PAID",
      razorpay_payment_id: response.razorpay_payment_id
    }).then(() => {
      alert("Payment Successful! Order Completed.");
      window.location.href = "index.html";
    });
  }
</script>
<script>
  function logout() {
    firebase.auth().signOut().then(function () {
      alert("Logged out successfully");
      window.location.href = "login.html";
    }).catch(function (error) {
      alert(error.message);
    });
  }
</script>

</body>
</html>
